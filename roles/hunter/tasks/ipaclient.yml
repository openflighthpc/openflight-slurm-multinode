- name: Client already enrolled in IPA?
  stat:
    path: "/etc/ipa/default.conf"
  register: ipa_conf
  failed_when: not ipa_conf.stat.exists
  ignore_errors: true
  tags:
    - never
    - pre
    - update

- name: Join IPA
  command: "ipa-client-install --no-ntp --mkhomedir --ssh-trust-dns --force-join --realm={{ ansible_facts['nodename'].split('.')[1:] |join('.') |upper }} --server={{ ipa_fqdn }} -p admin -w {{ secure_admin_password }} --domain {{ ansible_facts['nodename'].split('.')[1:] |join('.') }} --unattended --hostname={{ ansible_fqdn }}"
  when:
    - not ipa_conf.stat.exists
  tags:
    - never
    - pre
    - update
